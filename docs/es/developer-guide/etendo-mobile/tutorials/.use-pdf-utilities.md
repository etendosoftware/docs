## Visión general

En esta sección se explica cómo utilizar las utilidades de PDF (descarga y previsualización) en una subapp de Etendo.

!!! info
    Este tutorial requiere una subapp ya funcional. Si no dispone del entorno, siga los pasos de [Primeros pasos](../../../developer-guide/etendo-mobile/getting-started.md){target="_blank"} en la sección de Etendo Mobile.

## Configuración

----------
### Comprobación de dependencias

Antes de comenzar, asegúrese de tener las siguientes dependencias listadas en `package.json` e instaladas:

- [react-native-blob-util](https://github.com/RonRadtke/react-native-blob-util) versión 0.19.4
- [react-native-pdf](https://github.com/wonday/react-native-pdf) versión 6.7.1
- [react-native-share](https://github.com/react-native-share/react-native-share) versión 10.0.2


### Creación del hook

En la carpeta de hooks de su subapp, cree un nuevo archivo llamado *usePDF.tsx* y pegue el siguiente código:

```typescript
import { useState } from 'react';
import { Platform } from 'react-native';
import ReactNativeBlobUtil from 'react-native-blob-util';
import Share from 'react-native-share';

// Simple verification to check if the device is Android
const isAndroidDevice = (() => {
  return Platform.OS === 'android';
})();

// Constants for the download
const MIME_TYPE = 'application/pdf';
const FILE_EXTENSION = 'pdf';

const usePDF = () => {
  // Loacal States
  const [isLoading, setIsLoading] = useState(false);
  const [isDownloadDone, setIsDownloadDone] = useState(false);
  const [_pdf, setPdf] = useState<any>(null);
  const [path, setPath] = useState('');

  const downloadPDF = async ({
    url,
    method,
    fileName,
    optionsHeader,
    description,
    callback,
  }: {
    url: string;
    method: Methods;
    fileName: string;
    optionsHeader: any;
    description?: string;
    callback?: (...params: any[]) => void;
  }) => {
    // Set the path of the file and start the loading
    const dirs = ReactNativeBlobUtil.fs.dirs;
    const pathFile = `${
      isAndroidDevice ? dirs.LegacyDownloadDir : dirs.DocumentDir
    }/${fileName}.${FILE_EXTENSION}`;
    setPath(pathFile);
    setIsLoading(true);
    // Congfigurations for the download
    const config = {
      fileCache: true,
      appendExt: FILE_EXTENSION,
      path: pathFile,
      addAndroidDownloads: {
        mime: MIME_TYPE,
        title: `${fileName}.${FILE_EXTENSION}`,
        description: description || 'PDF File is dowmloaded.',
        mediaScannable: true,
        notification: true,
      },
    };

    ReactNativeBlobUtil.config(config)
      .fetch(method, url, optionsHeader)
      .then(res => {
        const filePath = res.path();
        const fileOptions = {
          path: filePath,
          mime: MIME_TYPE,
        };
        if (isAndroidDevice) {
          ReactNativeBlobUtil.fs.scanFile([fileOptions]);
        } else {
          let shareOptions = {
            type: MIME_TYPE,
            url: filePath,
            saveToFiles: true,
          };
          return Share.open(shareOptions);
        }
      })
      .then(_res => {
        // If the file is saved, set the state to true
        // and exceute the callback(if it exists)
        setIsDownloadDone(true);
        callback && callback();
      })
      .catch(err => {
        console.log(err);
      })
      .finally(() => {
        // Finally, set the loading to false
        setIsLoading(false);
      });
  };

  return { downloadPDF, isDownloadDone, isLoading, path, setPdf };
};

export default usePDF;
```
#### Explicación

Hay algunos aspectos a tener en cuenta en este hook:

- El hook gestiona únicamente la descarga del archivo PDF. Para previsualizarlo, deberá utilizar la librería *react-native-pdf*, lo cual se explicará con más detalle a continuación.
- La ruta del archivo se establece en la carpeta *LegacyDownloadDir* para dispositivos Android y en la carpeta *DocumentDir* para dispositivos iOS. Esto se debe a que la librería *react-native-blob-util* tiene una forma distinta de gestionar la descarga en cada plataforma. De este modo, el archivo es fácil de encontrar en ambas plataformas, pero puede cambiarlo si lo desea. Para más información, consulte la [documentación de react-native-blob-util](https://github.com/RonRadtke/react-native-blob-util)

#### Funciones y estados exportados

!!! abstract "Lista"
    - _downloadPDF_: es la función que gestiona la descarga del archivo PDF. Recibe un objeto con los siguientes parámetros:
        - _url_: la URL del archivo
        - _method_: el método de la solicitud
        - _fileName_: el nombre del archivo (sin la extensión *.pdf*)
        - _optionsHeader_: las opciones de la cabecera
        - _description_: la descripción del archivo que se mostrará en dispositivos Android durante el proceso de descarga (opcional)
        - _callback_: es una función de callback que se ejecutará cuando finalice correctamente (opcional)
    - _isDownloadDone_: es un booleano que indica si la descarga ha finalizado
    - _isLoading_: es un booleano que indica si la descarga está en curso
    - _path_: es la ruta final del archivo
    - _setPdf_: es una función que establece el archivo PDF (uso interno en el renderizado)


## Uso

----------
### Llamada al hook

En el archivo donde quiera utilizar el hook, impórtelo y llámelo:

```typescript
...
import { Button, Layout } from 'etendo-ui-library';
import usePDF from './hooks/usePDF';
...
```

!!! info "Componentes utilizados"
    Los componentes utilizados en este ejemplo (*Button* y *Layout*) son de la [Etendo UI Library](https://www.npmjs.com/package/etendo-ui-library)


### Descarga del PDF

Para descargar el archivo PDF, debe llamar a la función *downloadPDF* y pasar los parámetros. En este ejemplo, se utiliza un botón para desencadenar la descarga:

```typescript
...
const { downloadPDF, isLoading, isDownloadDone, path, setPdf } = usePDF();

return (
  ...
  <Layout
    children={
      <Button
        typeStyle="terciary"
        text="Download PDF"
        width={200}
        onPress={() =>
          downloadPDF({
            url: `https://your-url.com/your-pdf-file.pdf`,
            method: 'GET',
            fileName: 'fileNameOfPDF',
            optionsHeader: {
              'Content-Type': 'application/json',
            },
            description: 'File description',
          })
        }
        loading={isLoading}
      />
    }
  />
);

```

Esto se mostrará de la siguiente manera:

<figure markdown>
![main-screen.png](../../../assets/developer-guide/etendo-mobile/use-pdf-utilities/main-screen.png){ width="200", align=left style="border: 1px solid grey; border-radius: 8px;"}
![loading-screen.png](../../../assets/developer-guide/etendo-mobile/use-pdf-utilities/loading-screen.png){ width="200", align=right style="border: 1px solid grey; border-radius: 8px;"}
</figure>


### Previsualización del PDF

Para previsualizar el archivo PDF, debe utilizar la librería *react-native-pdf*. Siguiendo el ejemplo anterior, puede usar el estado *path* para establecer el origen del archivo PDF y la función *setPdf* para establecer el PDF:


```typescript
...
<View style={styles.container}>
  <Pdf
    ref={pdf => {
      setPdf(pdf);
    }}
    source={
      isDownloadDone && {
        uri: path,
      }
    }
    style={styles.pdf}
  />
</View>
```

!!! info "Estilos utilizados"
    Los estilos utilizados en este ejemplo (*container* y *pdf*) son los siguientes:
    ```typescript
      ...
      const width = Dimensions.get('window').width;
      const height = Dimensions.get('window').height;
      const styles = StyleSheet.create({
        container: {
          flexDirection: 'row',
          justifyContent: 'center',
          height,
          width,
          alignItems: 'center',
          marginTop: 25,
          backgroundColor: 'red',
        },
        pdf: {
          flex: 1,
          width,
          height,
        },
      });
    ```

Después de guardar, como resultado final, debería ver algo como esto:

<figure markdown>
  ![saving-file.png](../../../assets/developer-guide/etendo-mobile/use-pdf-utilities/saving-file.png){ width="200", align=left style="border: 1px solid grey; border-radius: 8px;"}
  ![pdf-show.png](../../../assets/developer-guide/etendo-mobile/use-pdf-utilities/pdf-show.png){ width="200", align=right style="border: 1px solid grey; border-radius: 8px;"}
</figure>

---
Este trabajo está licenciado bajo :material-creative-commons: :fontawesome-brands-creative-commons-by: :fontawesome-brands-creative-commons-sa: [ CC BY-SA 2.5 ES](https://creativecommons.org/licenses/by-sa/2.5/es/){target="_blank"} por [Futit Services S.L](https://etendo.software){target="_blank"}.