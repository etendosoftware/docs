## First steps with Etendo RX

In this page we'll give a step-by-step guide for working with Etendo RX, which involves building a new module with RX capabilities and creating a Spring Boot project to consume the projection generated by the RX microservice.

------------------------------------------------------------------

## Building a New Module for RX Capabilities

Before you begin, please ensure that you've completed the [**installation process**](/docs/developer-guide/etendo-rx/getting-started). This tutorial assumes that you've successfully set up the Etendo Platform.

### Accessing as Admin User

Log in to your account as an administrator. The default credentials are:

- Username: `admin`
- Password: `admin`

Once you're logged in, switch your role to "System Administrator".

### Creating a New Module

To create a new module, got to 'Module' windows, add a new record and provide the following information:

| Parameter       | Value                                   |
| --------------- | --------------------------------------- |
| Java Package    |  `com.tutorial.classictutorial`         |
| Name            |  `tutorial`                             |
| Description     |  `Module created for tutorial purposes` |
| Version         |  `1.0.0`                                |
| Is RX           |  `True`                                 |
| Rx Java Package |  `com.tutorial.rxtutorial`              |

With our new module created, we'll start working with 'Projections'

------------------------------------------------------------------

## Projection

Start by opening 'Projections' windows and creating a new projection with the following properties:

| Field       | Value                                |
| ----------- | ------------------------------------ |
| Module      | tutorial - 1.0.0 - English (USA)     |
| Name        | rxtutorial                           |
| Description | Projections needed for the tutorial  |

### Adding Table and Columns

Open the "Tables and Columns" window and look for the "Order" table.

### Adding a Projection

Next, navigate to the "Projections" tab and add a new projection with the following value:

| Field      | Value                                         |
| ---------- | --------------------------------------------- |
| Projection | rxtutorial - tutorial - 1.0.0 - English (USA) |

### Adding Entity Fields

Finally, navigate to the "Entity Field" tab and add the following fields:

|  Field Name         |  Property             |
| ------------------- | --------------------- |
| id                  |  id                   |
| businessPartnerName |  businessPartner.name |
| documentNo          |  documentNo           |
| documentTypeName    |  documentType.name    |
| grandTotalAmount    |  grandTotalAmount     |

------------------------------------------------------------------

## Repository

Same as defining projections on tables, to create a new repository we'll need to go to Tables and Columns and select 'C_Order' table

### Creating a New Repository

After selecting a table, in this case 'C_Order', we need to go to 'Repository' tab and create a new record with the following values:

| Field       | Value                                |
| ----------- | ------------------------------------ |
| Module      | tutorial - 1.0.0 - English (USA)     |

------------------------------------------------------------------

## Search

### Creating a New Search

Next, set up a new search method, under "Repository" tab of the C_Order table, using the following specifications:

| Field       | Value                                                                                  |
| ----------- | -------------------------------------------------------------------------------------- |
| Method Name |  `findSalesOrder`                                                                      |
|  Query      |  `select o from Order o where o.documentType.id = :documentType order by o.documentNo` |

### Creating a New Search Parameter

After creating a new search, you'll need to set up a corresponding search parameter. Use the following settings:

| Field | Value           |
| ----- | --------------- |
| Line  |  `10`           |
| Name  |  `documentType` |
| Type  |  `String`       |

------------------------------------------------------------------


## Creating a New Spring Boot Project

Now we will create a new spring boot project to consume the projection that we'll have created with a RX microservice.

### Project Creation

1. Visit [Spring Initializr](https://start.spring.io/) to start your project setup.
2. Fill in the following details:

    | Field        | Value                            |
    | ------------ | -------------------------------- |
    | Project      | Gradle Project                   |
    | Language     | Java                             |
    | Spring Boot  | 2.7.14 (or latest 2.7.x version) |


    Project Metadata

    | Field        | Value                      |
    | ------------ | -------------------------- |
    | Group        | com.tutorial               |
    | Artifact     | rxtutorial                 |
    | Name         | rxtutorial                 |
    | Description  | Etendo RX tutorial project |
    | Package Name | com.tutorial.rxtutorial    |
    | Packaging    | Jar                        |
    | Java Version | 11                         |

3. Add the following dependencies: Spring Web, Lombok, Config Client
4. Click on the 'Generate' button to download your project. The page will generate a file named `rxtutorial.zip`.
5. Uncompress the zip file to the platform project created in the first step, as: `modules_rx/com.tutorial.rxtutorial`.

### Project Configuration

#### Modify build.gradle File

Remove version of spring plugins:

```groovy
plugins {
    ...
    id 'org.springframework.boot' version '2.7.14'
    id 'io.spring.dependency-management' version '1.0.15.RELEASE'
}
```

Change it to this:

```groovy
plugins {
    ...
    id 'org.springframework.boot'
    id 'io.spring.dependency-management'
}
```

Gradle will get versions from the Etendo Platform project.

Add the following dependencies in the dependencies section:

```groovy
implementation 'org.springframework.cloud:spring-cloud-starter-openfeign'
implementation 'org.springframework.boot:spring-boot-starter-hateoas'
```

Add the Etendo repository:

```groovy
repositories {
    mavenCentral()
    maven {
        url = "https://maven.pkg.github.com/etendosoftware/etendo_rx"
        credentials {
            username = "${githubUser}"
            password = "${githubToken}"
        }
    }
}
```

!!! note
    `githubUser` and `githubToken` were configured in the first step.

Add custom source set:

```groovy
sourceSets {
    main {
        java {
            srcDirs = [
                'src/main/java',
                'src-gen/main/java',
            ]
        }
    }
}
```

Etendo compile task will generate java files in the `src-gen` directory.

------------------------------------------------------------------

## Configuring a Spring Boot Project

### Updating the application.properties file

Modify your `application.properties` file, under the new spring boot project created on the previous steps, with the following configurations:

```
config.server.url=http://localhost:8888
spring.config.import=configserver:${config.server.url}
spring.application.name=rxtutorial
server.port=8101
token=
```
### Adding the 'token' value

To generate the token value we need to follow theese steps:

  1. As 'System Administartor' role on the ERP, go to 'RX Services' window.
  2. Create a new row with the following values:

    |  Field Name         |  Property                        |
    | ------------------- | -------------------------------- |
    | Searchkey           |  Tutorial                        |
    | Secret              |  123                             |
    | Module              |  Tutorial - 1.0.0 - English (USA)|

  3. Change to 'F&B International Group Admin' role.
  4. Go to 'User' window.
  5. Choose a user, e.g. 'F&B ES User'
  
    !!! info
        Change the password for this record, you'll need it later.
        Also, check that the user is active.

  6. On the tab 'RX Services Access' create a new row and fill it with the following values:
    
    |  Field Name         |  Property                        |
    | ------------------- | -------------------------------- |
    | Organization        |  *                               |
    | RX Services         |  Tutorial                        |
    | Default Role        |  F&B España, S.A - Sales         |
    | Default Org         |  F&B España, S.A                 |

  7. Open Postman and we'll make a authenticate request.
  
    Verbose: POST

    URL: http://localhost:8094/api/authenticate

    Body:
    ```json
          {
            "username":"F&B ES User",
            "password":"EtendoAdmin1", // Password changed before
            "service":"Tutorial",
            "secret":"123"
          }
    ```
  
  8. Take the token under the response and fill in the 'token' property on the application.properties of the tutorial module.

### Adding Component Scan Annotation to the Application Class

To scan your application for annotated components, add the `@ComponentScan` annotation to your Application class with the necessary base packages:

```java
@ComponentScan({
    "com.tutorial.rxtutorial",
    "com.etendorx.clientrest.base",
})
```
!!! warning
    Remember to add the import for ComponentScan annotation: 
    ```java
    ...
    import org.springframework.context.annotation.ComponentScan
    ...
    ```

Hence, your Application class should look like:

```java
package com.tutorial.rxtutorial;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

@SpringBootApplication
@ComponentScan({
    "com.tutorial.rxtutorial",
    "com.etendorx.clientrest.base",
})
public class RxtutorialApplication {

  public static void main(String[] args) {
    SpringApplication.run(RxtutorialApplication.class, args);
  }

}
```

------------------------------------------------------------------

## Creating a New Spring Boot Service

Follow the instructions below to create a new service:

1. Create a new file at the following path:

```
modules_rx/com.tutorial.rxtutorial/src/main/java/com/tutorial/rxtutorial/RxtutorialService.java
```

2. Then, copy and paste the following code into the file:

```java
package com.tutorial.rxtutorial;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.etendorx.clientrest.base.RestUtils;
import com.etendorx.clientrest.base.RestUtilsException;
import com.tutorial.rxtutorial.entities.org.openbravo.model.common.order.OrderRxtutorialModel;

@RestController
@RequestMapping(path = "/api")
public class RxtutorialService {
  @Autowired
  RestUtils restUtils;

  @GetMapping(path = "/")
  public String get() throws RestUtilsException {
    String url = "/Order/search/findSalesOrder?documentType=AB22CE8FFA5E4AF29F2AC90FCDD400D8&projection=rxtutorial";
    var orders = restUtils.getList(url, OrderRxtutorialModel.class);
    StringBuilder html = new StringBuilder("<html>");
    html.append("<head>");
    html.append("<style type=\"text/css\">html {font-family: sans-serif;}</style>");
    html.append("</head>");
    html.append("<title>Orders</title></head>");
    html.append("<body>");
    html.append("<h2>Orders</h2>");
    html.append("<table>");
    for (OrderRxtutorialModel o : orders) {
      html.append(
          "<tr>" +
              "<td>" + o.getDocumentNo() + "</td>" +
              "<td>" + o.getBusinessPartnerName() + "</td>" +
              "<td>" + o.getDocumentTypeName() + "</td>" +
              "<td>" + o.getGrandTotalAmount() + "</td>" +
              "</tr>"
      );
    }
    html.append("</table></body></html>");
    return html.toString();
  }
}
```

------------------------------------------------------------------

## Run RX Services

To simplify RX executions you have a simplified run task:

```
./gradlew rx:rx
```

## Configure auth project

Check Auth log file in:

src-rx/logs/auth.log

You will find something like this:

---

Populate the auth.yaml file with the following property:
token: eyJhbGciOiJSUzI1NiJ9... (truncated)

---

Copy the value of token line and replace the token value in the file:

src-rx/rxconfig/auth.yaml

replace default empty token value with log content

```
 token: eyJhbGciOiJSUzI1NiJ9... (truncated)
```

# Run tutorial project:

```
./gradlew :com.tutorial.rxtutorial:bootRun
```

# Open in your browser

You can view the generated page:

[**http://localhost:8101/api/**](http://localhost:8101/api/)

Great job! You've successfully created a fully working rx service.
